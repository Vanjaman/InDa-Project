# 'requests' is a HTTP library for sending HTTP requests and more.
# 'requests' is used to fetch the HTML of KTH's cloud.timeedit schedules to 
# get information about when and where rooms are booked at KTH.
# - https://docs.python-requests.org/en/latest/
import requests 
# "Beautiful Soup is a Python library for pulling data out of HTML and XML files".
# This will be used in combination with the requests library above.
# - https://www.crummy.com/software/BeautifulSoup/bs4/doc/
from bs4 import BeautifulSoup
# re is a library for using Regex
import re
# the scraper writes to a csv file
import csv
file = open("bookings.csv", "w", newline='', encoding='utf-8')
writer = csv.writer(file)
writer.writerow(["Start Time", "End Time", "Premise"]) # Header in csv-file

# Premises to check for in the title attribute containing the information
knownPremises = ["4618", "3721", "4523", "5O1Spe (Spelhallen)", "5O2Spo (Sporthallen)", 
                 "5O3Mus (Musiksalen)", "5O4Kons (Konsthallen)", "5O5Mat (Matsalen)", 
                 "D/LV5 (Ljusgård, D)", "D1", "D2", "D3", "D31", "D33", "D34", "D35", 
                 "D36 (Gamla styrelserummet)", "D37", "D41", "D42", "D4448", "Haptik labb",
                 "Middla Design studio", "Multi Studio", "VIC-studion", "1448", "1537", "1625",
                 "4V2Röd (Röd)", "4V3Ora (Orange)", "4V4Gul (Gul)", "4V5Grö (Grön)", "4V6 Bru (Brun)", 
                 "5V1Grå (Grå)", "5V2Kar (Karmosin)", "5V3Vit (Vit)", "5V4Mag (Magenta)", "5V5Vio (Violett)",
                 "5V6Tur (Turkos)", "E/1315", "E/LV3", "E1", "E2", "E3", "E31", "E32", "E33", "E34",
                 "E35", "E36", "E51", "E52", "E53", "Q1", "Q11","Q13","Q15","Q17","Q2","Q21","Q22","Q24",
                 "Q26","Q31","Q33","Q34","Q36","XQ23","XQ25","XQ32"]

# URL to be scraped
url = "https://cloud.timeedit.net/kth/web/public01/ri15XXQ4053Z58Qv0903X046y7Y840Y77YX1Y0gQ6028789ZY4778807098Y08889X7YYX4779088XX678970Y78909777X5Y779238X717Y877XXXY06775785Y78850988937788Y9Y88X59788Y99X00976X8850977988704377XX77Y3XY9388X7Y78857Y8813YY479Y9836977789Y6619YY8933287X37Y96X3878XX7376XX87778Y7Y67XY792697XX9Y776Y779984787YX4768644198X4468859787X607999XY804Y788X700YY676787475X6X779Y7077X679Y8783978YYY276877866089957X55X687492X292Y7X7303XXY73X68Y1677178X7884XX76YY8828Y0X692Y7279978249973578X3X979X888562996X117X77667Y773X9Y7677YY8679YY8778717198Y06669X7YYX1779288XX878171Y78969776X4Y779326X707Y677XXXY27770743Y76642986957787Y9Y88X49788Y39X49313X8245437388783334XX77Y1XY3181X4Y31947Y8513YY47XY7300378X87Y11678X839005387QY.html"
# IF WE WANT TO SCRAPE ALL PREMISES:
# https://cloud.timeedit.net/kth/web/public01/ri15XXQ8093Z58Qv8909X886y7Y940Y77YX1Y7gQ7028979ZY9778917858Y89969X7YYX9879888XX408379Y78969779X3Y779059X717Y268XXXY00339763Y71455084367883Y3Y88X44388Y33X01397X8083337988789944XX77Y6XY9286X7Y76437Y8667YY379Y9899977783Y9659YY8913037X17Y39X1878XX7879XX83774Y7Y67XY877193XX3Y779Y779984787YX9798490098X1468889787X147999XY844Y788X709YY675687472X6X779Y6477X669Y8781978YYY477777894087977X99X787090X056Y8X8638XXY78X48Y2978578X5189XX79YY8835Y8X979Y8179978837971278X1X039X888391999X232X57947Y785X3Y7574YY8075YY8778378898Y64883X7YYX7770888XX078977Y78929038X0Y779488X737Y777XXXY71770704Y77850987937787Y9Y88X09788Y39X53987X8725547988719976XX77Y7XY9487X7Y77757Y8777YY589Y9809577780Y9719YY8916260X97Y93X9878XX7679XX87774Y7Y77XY283797XX9Y777Y779982787YX2778711498X2278829787X127399XY819Y788X391YY773783279X3X779Y7777X373Y8782388YYY973770897189973X79X187150X468Y7X7169XXY00X08Y9570078X8980XX87YY8860Y4X560Y8480908470087408X4X295X888509504X913X90448Y989X5Y9483YY8485YY0888407608Y15556X8YYX0883588XX308885Y08030365X0Y000795X868Y508XXXY05006834Y85550085078085Y0Y88X50088Y00X77020X8076708088830006XX88Y5XY0485X0Y05568Y8550YY679Y9877977781Y6889YY8907227X27Y98X7878XX7977XX87774Y7Y68XY358697XX9Y776Y779582785YX3768622098X3268892781X707989XY832Y788X771YY475687574X6X779Y3387X669Y8781378YYY346777866289374X99X787792X276Y7X7181XXY76X67Y4777778X2686XX76YY8809Y1X689Y7279978119971178X2X479X888360997X440X77667Y772X9Y7577YY8679YY3778767698Y63773X7YYX6779988XX978778Y78949737X5Y779266X737Y677XXXY80779734Y76699986977786Y9Y88X99788Y39X16957X8001937988729979XX77Y6XY9986X7Y76497Y8667YY975Y9886977885Y8615YY8989047X95Y56X9878XX8578XX85580Y5Y88XY497855XX5Y558Y885588885YX8888887858X8888825585X175555XY888Y588X526YY884885881X8X885Y8788X885Y8889588YYY758885888785555X65X888559X998Y5X8819XXY56X87Y3855788X7786XX88YY8899Y8X699Y8975578765978878X9X579X888967998X778X77887Y776X9Y7470YY8879YY7778447138Y77499X8YYX1773188XX738489Y98555274X6Y933353X857Y478XXXY41878874Y74773784708887Y9Y88X69888Y77X74768X8577788988737780XX88Y4XY7888X8Y74488Y8448YY887Y9888787881Y4487YY8768368X68Y94X9888XX8274XX87872Y7Y47XY148897XX9Y888Y877987887YX9788899378X9748817888X278777XY887Y888X853YY480488789X4X887Y4888X447Y8489388YYY883780891883773X99X187864X079Y3X7244XXY77X77Y2737778X8087XX72YY8899Y8X729Y7079378879978878X2X279X888682998X227X77887Y772X9Y7871YY8879YY9778837298Y28889X7YYX3779388XX378773Y78909778X0Y779828X757Y977XXXY06770779Y78900989987789Y9Y88X39788Y99X33957X8653477988749970XX77Y8XY9388X7Y78927Y8887YY379Y9848977782Y8899YY8944817X47Y98X4878XX7778XX87775Y7Y87XY604897XX9Y778Y779984787YX3788844498X4098809787X307999XY853Y788X761YY975987074X8X779Y9577X999Y8982978YYY578777888089977X59X987690X297Y7X7241XXY79X77Y7447778X1187XX75YY8859Y8X789Y7572378429979178X8X575X888074995X994X77777Y778X9Y1374YY8789YY9778797998Y97779X7YYX9789988XX878370Y78919777X7Y706643X787Y178XXXY96723760Y87520987927287Y5Y88X29788Y99X29927X8132277988789470XX77Y9XY9187X7Y79737Y8926YY779Y9827977787Y7759YY8933987X37Y99X3878XX7079XX87771Y7Y77XY424997XX9Y777Y779983787YX3778732398X3478829387X097993XY814Y788X781YY778183176X7X779Y9477X173Y8187978YYY431773877483377X69X987739X019Y4X7852XXY78X57Y8774778X0385XX79YY8819Y6X470Y7289908523786088X4X679X888004907X306X70977Y772X9Y7780YY8879YY4778847098Y07879X7YYX0779488XX078370Y78949778X6Y779958X727Y877XXXY03770768Y78850988917788Y9Y88X59788Y99X55973X8754077988783075XX77Y1XY3586X3Y78888Y8150YY089Y3807687784Y6024YY8024250X77Y43X2808XX7649XX86775Y7Y57XY598390XX0Y007Y870386883YX0838529408X9658890080X750000XY856Y088X091YY585580680X5X880Y5588X550Y8580088YYY505880855580000X10X588305X021Y0X8820XXY78X87Y3847778X1988XX78YY8869Y5X869Y7279378619978678X5X079X888685998X663X77887Y775X9Y7274YY8879YY5778857528Y68449X7YYX6779888XX878275Y78259778X1Y772374X797Y877XXXY56474788Y77427987967787Y2Y88X49788Y43X35484X8913247488744443XX77Y8XY4088X4Y48817Y8884YY274Y4828477781Y8844YY8432324X24Y48X2848XX7748XX84476Y4Y87XY809844XX4Y448Y774481784YX1788831748X3188824484X724444XY821Y488X491YY878884276X8X774Y8277X884Y8786978YYY377777877689977X39X787296X615Y7X7417XXY77X77Y0777778X2587XX77YY8879Y8X779Y7779978709978778X7X977X888570390X554X27577Y477X9Y9376YY8483YY2778457538Y54443X7YYX5773588XX328875Y28343224X1Y223694X877Y427XXXY55226834Y77496385607284Y3Y88X53588Y35X62362X8926647388743629XX77Y4XY3484X2Y24768Y8416YY673Y9808977785Y8979YY8953087X52Y38X0878XX7074XX82777Y2Y47XY180432XX3Y254Y873387782YX6748466358X6498857882591Y57QX.html

# The user-agent retrieved from "my user-agent" search query in Google
# A user-agent is the agent that tries to send the request on behalf of the user
headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.74 Safari/537.36"}

# Returns a HTTP response with the HTML of the url
page = requests.get(url, headers=headers)

# Parses the HTML and puts it in a easier format with BeautifulSoup
soup = BeautifulSoup(page.content, 'html.parser')

# Find all divs with the class bookingDiv (these contain information about date, time, etc. for a booking)
bookingDivs = soup.findAll("div", "bookingDiv")

# The title attributes contain a string will all important information concerning the booking
titles = []
for bookingDiv in bookingDivs:
    titles.append(bookingDiv["title"])

# Format for date and time
date = re.compile("\\d{4}-\\d{2}-\\d{2}")
time = re.compile("\\d{2}:\\d{2} - \\d{2}:\\d{2}")

# Write booking information to csv file in format: startTime, endTime, premise
# (example): 2022-04-16T08:00,2022-04-16T21:00,5O2Spo (Sporthallen)
for title in titles:
    premisesFoundInTitle = []
    # Date
    dateResult = date.search(title).group(0)
    # startTime and endTime
    timeResult = time.search(title).group(0).split("-")
    # Find the booked premise(s) name
    for premise in knownPremises:
        if title.__contains__(premise):
            premisesFoundInTitle.append(premise)
    # Create the csv row entry
    for csvEntry in range(len(premisesFoundInTitle)):
        csvRow = []
        csvRow.append(dateResult+"T"+timeResult[0].strip())
        csvRow.append(dateResult+"T"+timeResult[1].strip())
        csvRow.append(premisesFoundInTitle[csvEntry])
        writer.writerow(csvRow)
file.close()
